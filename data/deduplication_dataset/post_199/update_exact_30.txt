AI 에이전트의 성능 향상을 위한 DSPy 기반 GEPA 프롬프트 최적화

최근 인공지능(AI) 기술의 발전은 자동화된 코딩 에이전트(AI coding agents)의 가능성을 현실로 만들고 있습니다. 특히 데이터 과학 분야에서 이러한 에이전트들은 데이터 처리, 분석, 시각화 등 복잡한 작업을 수행하며 생산성을 혁신하고 있습니다. 그러나 이러한 AI 에이전트의 성능은 기반이 되는 대규모 언어 모델(LLMs)의 프롬프트(prompt) 품질에 크게 의존합니다. 효과적인 프롬프트는 에이전트의 정확성과 효율성을 결정짓는 핵심 요소입니다. 이 블로그 게시물은 GEPA를 사용한 DSPy 프롬프트 최적화를 통해 AI 데이터 과학자에서 사용되는 AI 코딩 에이전트(AI coding agents)를 개선하는 방법에 대한 기술적인 설명입니다. 이 블로그는 다음 주제를 다룹니다: 데이터 준비 GEPA 설명 DSPy를 통한 프롬프트 최적화(GEPA) 적용 결과

1. 데이터 준비

AI 코딩 에이전트의 성능을 최적화하기 위한 첫 단계는 고품질의 데이터를 준비하는 것입니다. 에이전트는 다양한 실제 시나리오에서 파이썬(Python) 코드를 생성하고 실행하므로, 이들의 학습 및 평가를 위한 데이터셋(dataset)은 이러한 복잡성을 반영해야 합니다. 저희 시스템에서는 에이전트가 생성한 코드 실행 결과와 그 성공 여부를 면밀히 분석하여 데이터셋을 구성하며, 이는 에이전트의 행동 패턴과 성능에 대한 귀중한 통찰력을 제공합니다.

데이터셋(dataset)은 저희 제품을 통해 실행된 파이썬(Python) 코드 실행 결과로 구성됩니다. 자동 분석기(auto-analyst)는 여러 부분으로 구성된 AI 시스템(AI system)으로, 각 부분은 특정 코딩 작업을 위해 설계되었습니다. 한 부분인 전처리 에이전트(pre-processing agent)는 판다스(pandas)를 사용하여 데이터를 정리하고 준비합니다. 다른 부분인 데이터 시각화 에이전트(data visualization agent)는 플로틀리(plotly)를 사용하여 차트와 그래프를 생성합니다.

이 시스템에는 약 12개의 고유한 시그니처(signature)가 있으며, 각각 두 가지 버전이 있습니다. 하나는 플래너(planner)를 사용하는 버전이고, 다른 하나는 '@agent' 쿼리(query)에 대해 자체적으로 실행되는 버전입니다. 하지만 이 블로그 게시물에서는 이 시그니처 중 4개와 그 두 가지 변형에만 초점을 맞출 것입니다. 이 4가지 시그니처만으로도 전체 코드 실행의 약 90%를 차지하는데, 이는 무료 사용자든 유료 사용자든 거의 모든 사람이 사용하는 기본 시그니처이기 때문입니다.
preprocessing_agent
data_viz_agent
statistical_analytics_agent
sk_learn_agent
데이터셋(dataset)은 시스템에서 제공하는 기본 데이터셋과 사용자가 직접 업로드하는 데이터로 나눌 수 있습니다. 카테고리별 코드 실행 성공률 저희 목표는 어떤 최적화든 두 가지 모두에서 성능을 향상시키는 것입니다. 기본 데이터뿐만 아니라 사용자가 업로드하는 데이터셋(dataset)에서도 잘 작동해야 합니다. 이를 위해 데이터를 계층화(stratify)해야 합니다. 그렇게 하면 모델(model)이 기본 데이터셋(dataset)에 과적합(overfit)되지 않고 다양한 입력을 효과적으로 처리할 수 있습니다. 고려해야 할 또 다른 중요한 요소는 모델 제공업체(model providers)입니다. 한 제공업체에 대해서만 최적화하여 다른 제공업체의 성능을 저해하고 싶지는 않습니다. 참고: 저희 시스템에서 사용자들은 주로 GPT-4o-mini와 같은 OpenAI의 저렴한 모델(model)을 사용한 반면, 제미니(Gemini)의 경우 사용자들은 최고급 모델(model)만 사용했기 때문에 여기에 편향(bias)이 있습니다. 모델(model)별로 평가할 충분한 데이터(data)가 없으므로, 제공업체(provider)를 대리(proxy)로 사용하고 있습니다. 최고급 OAI 모델(model)과 다른 제공업체(provider)의 최고급 모델(model)을 비교했을 때, OpenAI의 성공률은 비슷합니다. 데이터셋(dataset)을 준비한 후, 다음 제약 조건(constraint)을 사용하여 계층화된 샘플(stratified sample)을 생성했습니다: 데이터의 20% 이상이 기본 데이터셋(dataset)에서 오지 않습니다 ( is_default_dataset == True ). 세 가지 모델 제공업체(model providers) ( openai , anthropic , gemini ) 각각이 최종 샘플(sample)의 최소 10%를 차지합니다. 계층화(stratification)는 다음 세 가지 열(column)에 걸쳐 수행되었습니다:
model_provider
is_successful
is_default_dataset
계층화된 샘플(stratified sample)이 생성된 후, 평가에 사용될 훈련 세트(training set)와 테스트 세트(test set)로 분할했습니다.

2. GEPA 설명

GEPA는 AI 프롬프트(AI prompts)와 같은 텍스트 구성 요소(text components)를 진화시키고 개선하기 위해 리플렉션(reflection)을 사용하는 DSPy 프로그램(program)용으로 설계된 진화적 프롬프트 최적화기(evolutionary prompt optimizer)인 (Generic-Pareto)의 약자입니다. GEPA는 대규모 언어 모델(LLMs)이 프로그램(program)의 실행 궤적(execution trajectory)을 성찰하고, 무엇이 효과가 있었고 무엇이 없었는지 진단하며, 자연어 리플렉션(natural language reflection)을 통해 개선 사항을 제안하는 능력을 활용합니다. 1년 동안 50% 할인

이는 단순히 하나의 목표에만 집중하는 것이 아니라, 정확도, 실행 속도, 비용 효율성 등 여러 상충하는 목표 사이의 균형점을 찾는 다중 목표(Pareto) 최적화(optimization) 접근 방식을 취합니다. GEPA의 핵심은 이러한 다중 목표를 기반으로 더 나은 프롬프트(prompt)를 반복적으로 테스트하고 선택함으로써 진화된 프롬프트 후보(prompt candidates)의 트리(tree)를 구축한다는 점입니다. 이 진화 과정은 LLM이 생성한 초기 프롬프트들을 '개체'로 보고, 이들을 평가하여 성능이 좋은 개체를 선택하고, 변형(mutation) 및 조합(crossover)을 통해 새로운 프롬프트 후보들을 생성하며 반복적으로 개선해 나가는 방식으로 진행됩니다. DSPy 프레임워크는 이러한 복잡한 진화적 최적화 과정을 추상화하여, 개발자가 프롬프트 엔지니어링에 드는 시간과 노력을 크게 줄일 수 있도록 돕습니다.

3. DSPy를 통한 프롬프트 최적화(GEPA) 적용

GEPA를 DSPy 프로그램에 적용하는 것은 AI 에이전트의 견고성과 성능을 극대화하는 데 필수적인 과정입니다. DSPy는 LLM 호출을 모듈화하고, 이러한 모듈을 컴파일하여 최적화된 프롬프트를 생성하는 강력한 프레임워크를 제공합니다. GEPA는 이 DSPy 컴파일러(compiler)의 한 종류로, 진화적 알고리즘과 LLM의 리플렉션 능력을 결합하여 프롬프트를 자동으로 개선합니다.

적용 단계는 다음과 같습니다:
1.  **DSPy 프로그램 정의:** 먼저 AI 에이전트의 작업을 나타내는 DSPy 프로그램을 정의합니다. 이는 `dspy.Signature`와 `dspy.Module`을 사용하여 에이전트의 입력-출력 명세와 내부 추론 단계를 명확히 합니다.
2.  **평가 메트릭 설정:** 에이전트의 성공 여부를 측정할 명확한 평가 메트릭을 정의합니다. 이는 코드 실행 성공률, 정확성, 응답 시간, 비용 등 다중 목표 최적화를 위한 기준이 됩니다.
3.  **GEPA 컴파일러 실행:** 준비된 데이터셋과 평가 메트릭을 사용하여 GEPA 컴파일러를 실행합니다. GEPA는 반복적으로 프롬프트 후보들을 생성하고, LLM을 통해 이들을 평가하며, 리플렉션을 통해 개선 방향을 도출합니다. 이 과정에서 파레토 최적화 원칙에 따라 여러 목표를 동시에 고려하여 최적의 프롬프트를 찾아냅니다.
4.  **최적화된 프로그램 배포:** GEPA에 의해 최적화된 프롬프트가 적용된 DSPy 프로그램을 실제 환경에 배포합니다. 이 프로그램은 기존보다 훨씬 더 효율적이고 정확하게 작동할 것입니다.

예를 들어, 데이터 과학 에이전트가 특정 데이터셋에 대한 통계 분석 코드를 생성해야 한다고 가정해봅시다. 초기 프롬프트는 일반적인 지침을 제공하지만, GEPA는 실패 사례를 분석하여 "결측치 처리 방법을 명시하라", "이상치 탐지 로직을 추가하라"와 같은 구체적인 개선 사항을 프롬프트에 반영합니다. 이러한 반복적인 개선을 통해 에이전트는 다양한 데이터 조건에서 더 견고하고 정확한 코드를 생성할 수 있게 됩니다.

결론적으로, GEPA와 DSPy의 결합은 AI 코딩 에이전트의 프롬프트 최적화에 있어 강력한 솔루션을 제공합니다. 이는 수동 프롬프트 엔지니어링의 한계를 극복하고, 다양한 실제 시나리오에서 AI 에이전트의 성능과 신뢰성을 획기적으로 향상시킬 수 있는 길을 열어줍니다. 앞으로 이러한 자동화된 최적화 기술은 더욱 발전하여, AI 에이전트가 더 복잡하고 미묘한 작업을 자율적으로 수행하는 데 기여할 것으로 기대됩니다.